# DisposableGenerator
Source Generator for simplifying implementation of the IDisposable interface.

## Why use DisposableGenerator?

This project draws inspiration from the https://github.com/Fody/Janitor project. Instead of relying on "IL weaving", the project takes advantage of the .NET 5 compiler's "Source Generator" functionality.

Neither approach is clearly superior, Source Generators can check some boxes that IL weaving cannot, and vice versa. See the project comparison below.

DisposableGenerator is a DesignTime / CompileTime source generator which automatically implements the Dispose Pattern https://docs.microsoft.com/en-us/dotnet/standard/garbage-collection/implementing-dispose.

All that you, the developer, need to do is implement one or both of "DisposeManaged" or "DisposeUnmanaged", depending on the type of resources you are dealing with.

## What does the generator do?

This generator will automatically create a Dispose implementation depending on the types of resources needing disposal.

- Looks for classes that inherit IDisposable
- Implements Dispose as a stub until either one of two methods are implemented by the developer:
  - `void DisposeManaged()` - Dispose any managed objects, including any SafeHandles or Disposable members
  - `void DisposeUnmanaged()` - Dispose any unmanaged handles or resources.
- Adds a finalizer whenever `DisposeUnmanaged` is present.

### Example 1: Simple Dispose

You write:

```csharp
public partial class Example1 : IDisposable
{
    MemoryStream stream;

    public Sample()
    {
        stream = new MemoryStream();
    }

    // Dispose method automatically generated.
}
```

Generated code:

```csharp
// <auto-generated />
public partial class Example1
{
    public void Dispose()
    {
        stream.Dispose();
    }
}
```

### Example 2: Disposal of unmanaged resources

You write:

```csharp
public partial class Example2 : IDisposable
{
    IntPtr handle;

    public Example2()
    {
        handle = Marshal.AllocHGlobal<byte>(256);
    }

    public void Foo()
    {
        // Use handle in some way
    }

    public DisposeUnmanaged()
    {
        if (handle != IntPtr.Zero)
        {
            Marshal.FreeHGlobal(handle);
        }
    }
}
```

Generated code:

```csharp
// <auto-generated />
public partial class Example2
{
    private bool _disposed = false;

    public void Dispose()
    {
        Dispose(true);
        GC.SuppressFinalize(this);
    }

    private void Dispose(bool disposing)
    {
        if (_disposed)
        {
            return;
        }

        if (disposing)
        {
            // No unmanaged resources to dispose
        }

        DisposeUnmanaged();
        _disposed = true;
    }
}
```

## Comparison to Fody.Janitor

| Feature | DisposableGenerator | Fody.Janitor |
| --- | --- | ---|
| Implements `Dispose` directly | Yes | No |
| Auto-dispose member fields | Yes* | Yes |
| `DisposeManaged` | Yes | Yes |
| `DisposeUnmanaged` | Yes | Yes |
| Auto-throw on dipsosed | No | Yes |
| Custom warnings and errors | Yes* | No |

*Planned feature

## Using the project

NuGet coming soon.